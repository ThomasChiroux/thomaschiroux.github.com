<!DOCTYPE html>
<html lang="en">
<head>
        <title>chiroux.org - linux</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href=".././theme/css/main.css" type="text/css" />
        
        <link href="http://chiroux.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="chiroux.org Atom Feed" />
        
        

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href=".././css/ie.css"/>
                <script src=".././js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href=".././css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">

<a href="https://github.com/ThomasChiroux">

<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />

</a>

        <header id="banner" class="body">
                <h1><a href="../.">chiroux.org </a></h1>
                <nav><ul>
                
                
                
                
                
                    <li ><a href=".././category/python.html">python</a></li>
                
                    <li ><a href=".././category/meta.html">meta</a></li>
                
                    <li ><a href=".././category/adminsys.html">adminsys</a></li>
                
                </ul></nav>
        </header><!-- /#banner -->
                

            

        
        
            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href=".././installation-dun-couple-de-serveurs-dhcp-et-dns-redondants.html">Installation d'un couple de serveurs dhcp et dns redondants</a></h1> 
                    <footer class="post-info">
        <abbr class="published" title="2009-09-30T00:15:00">
                Wed 30 September 2009
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href=".././author/thomas-chiroux.html">Thomas Chiroux</a>
        </address>
        
<p>In <a href=".././category/adminsys.html">adminsys</a>. </p>
<p>tags: <a href=".././tag/bind.html">bind</a> <a href=".././tag/configuration.html">configuration</a> <a href=".././tag/dhcp.html">dhcp</a> <a href=".././tag/jaunty.html">jaunty</a> <a href=".././tag/linux.html">linux</a> <a href=".././tag/redondant.html">redondant</a> <a href=".././tag/ubuntu.html">ubuntu</a> </p>


</footer><!-- /.post-info --><img alt="Networked - CC - auteur: http://www.flickr.com/photos/superkimbo/1727117782/" src="../static/media/images/network_servers.jpg" style="width: 500px; height: 333px;" />
<p>Cette fois ci, on s'oriente plus du côté des petites entreprises qui ont
rapidement besoin d'une gestion interne du réseau, simple, efficace et
sécurisée. Le but de cet article est donc de montrer pas à pas comment
monter deux serveurs dhcp+dns qui se backupent l'un l'autre de manière
transparente. Ces deux serveurs seront les piliers du réseau naissant de
la petite entreprise.</p>
<p>Pour l'installation de base, il suffit de suivre
le <a class="reference external" href="http://chiroux.org/installation-dun-serveur-web-securise-sous-ubuntu-9-04server/">tuto d'installation d'un serveur ubuntu</a>, en s'arrêtant juste avant
l'install de lighttpd qui n'est pas nécessaire ici (mais cela marche
aussi avec bien sûr). Le tuto a l'air assez long mais il est
relativement simple et rapide à mettre en oeuvre : en partant de deux
serveurs vides, non installés, suivre les deux tutos d'install générique
et celui ci de dhcp+dns, il suffit d'a peine 2H pour tout terminer et
avoir ses serveurs fonctionnels.</p>
<div class="section" id="introduction">
<h2>Introduction</h2>
<ul class="simple">
<li>Nous allons utiliser, classiquement, les serveurs bind et dhcpd 3</li>
<li>L'installation s'effectue sur deux machines, que l'on nommera
respectivement ns1 et ns2</li>
<li>Le domaine installé est volontairement local et sera appelé :
monentreprise.local</li>
<li>Le réseau local sera la classe C : 192.168.1.0/24</li>
<li>et les machines ns1 et ns2 auront respectivement les ips :
192.168.1.10 et 192.168.1.11</li>
<li>la passerelle internet sera 192.168.1.1</li>
</ul>
<p>toutes ces valeurs sont des hypothèses et doivent être adaptées en
fonction de votre config. A la fin de l'installation, nous devrions
avoir deux serveurs, un 'maitre' dhcp et dns (ns1) et son 'esclave'
(ns2). Les baux dhcp délivrés par le maitre étant mis à jour
automatiquement dans le dns, le tout répliqué automatiquement sur
l'esclave. L'esclave prenant le relais automatiquement si le maître ne
marche plus.</p>
</div>
<div class="section" id="installation-de-base-et-commune-aux-deux-serveurs">
<h2>Installation de base et commune aux deux serveurs</h2>
<p>Comme son nom l'indique, il faut donc executer ces lignes de façon
identique sur chacun des deux serveurs.</p>
<div class="section" id="installation-des-paquets">
<h3>Installation des paquets</h3>
<div class="section" id="dhcp">
<h4>dhcp</h4>
<div class="highlight"><pre>sudo apt-get install dhcp3-server
</pre></div>
<p>on stoppe le serveur tant qu'il n'est pas configuré pour éviter de mettre la
grouille sur le réseau:</p>
<div class="highlight"><pre>sudo /etc/init.d/dhcp3-server stop
</pre></div>
</div>
<div class="section" id="dns">
<h4>dns</h4>
<div class="highlight"><pre>sudo apt-get install bind9
</pre></div>
</div>
</div>
<div class="section" id="preparation-du-firewall">
<h3>Préparation du firewall</h3>
<p>Dans le firewall, il est nécessaire d'ouvrir explicitement quelques
ports pour :</p>
<ul class="simple">
<li>le dns</li>
<li>la mise a jour dynamique des dns suite aux baux délivrés par le dhcp</li>
<li>la synchronisation des dhcps entre eux</li>
</ul>
<p>Editer le fichier du firewall :</p>
<div class="highlight"><pre>sudo vim /etc/init.d/server_iptables
</pre></div>
<p>et ajouter les lignes suivantes :</p>
<div class="highlight"><pre><span class="c"># Autorise les requetes DNS</span>
iptables -A INPUT -s 192.168.1.0/24 -p tcp -i eth0 --dport 53 -j ACCEPT
iptables -A INPUT -s 192.168.1.0/24 -p udp -i eth0 --dport 53 -j ACCEPT
<span class="c"># Autorise les MAJ DDNS</span>
iptables -A INPUT -s 192.168.1.0/24 -p tcp -i eth0 --dport 953 -j ACCEPT
<span class="c"># Autorise le failover dhcp</span>
iptables -A INPUT -s 192.168.1.0/24 -p tcp -i eth0 --dport 647 -j ACCEPT
</pre></div>
<p>On remarque ici qu'on
autorise ces ports uniquement depuis les adresses de notre réseau local.
On pourrait encore durir les règles en autorisant les maj ddns et les
synchros dhcp uniquement depuis nos deux serveurs.</p>
<p>Relancer les règles
du Firewall:</p>
<div class="highlight"><pre>sudo /etc/init.d/server_iptables
</pre></div>
</div>
<div class="section" id="preparation-du-dns-configuration-du-logging-en-mode-debug">
<h3>préparation du dns : configuration du logging en mode debug</h3>
<div class="highlight"><pre>sudo vim /etc/bind/named.conf.debug.log
</pre></div>
<div class="highlight"><pre>logging <span class="o">{</span>
  category <span class="s2">&quot;default&quot;</span> <span class="o">{</span> <span class="s2">&quot;debug&quot;</span>; <span class="o">}</span>;
  category <span class="s2">&quot;general&quot;</span> <span class="o">{</span> <span class="s2">&quot;debug&quot;</span>; <span class="o">}</span>;
  category <span class="s2">&quot;database&quot;</span> <span class="o">{</span> <span class="s2">&quot;debug&quot;</span>; <span class="o">}</span>;
  category <span class="s2">&quot;security&quot;</span> <span class="o">{</span> <span class="s2">&quot;debug&quot;</span>; <span class="o">}</span>;
  category <span class="s2">&quot;config&quot;</span> <span class="o">{</span> <span class="s2">&quot;debug&quot;</span>; <span class="o">}</span>;
  category <span class="s2">&quot;resolver&quot;</span> <span class="o">{</span> <span class="s2">&quot;warning&quot;</span>; <span class="o">}</span>;
  category <span class="s2">&quot;xfer-in&quot;</span> <span class="o">{</span> <span class="s2">&quot;debug&quot;</span>; <span class="o">}</span>;
  category <span class="s2">&quot;xfer-out&quot;</span> <span class="o">{</span> <span class="s2">&quot;debug&quot;</span>; <span class="o">}</span>;
  category <span class="s2">&quot;notify&quot;</span> <span class="o">{</span> <span class="s2">&quot;debug&quot;</span>; <span class="o">}</span>;
  category <span class="s2">&quot;client&quot;</span> <span class="o">{</span> <span class="s2">&quot;debug&quot;</span>; <span class="o">}</span>;
  category <span class="s2">&quot;unmatched&quot;</span> <span class="o">{</span> <span class="s2">&quot;debug&quot;</span>; <span class="o">}</span>;
  category <span class="s2">&quot;network&quot;</span> <span class="o">{</span> <span class="s2">&quot;debug&quot;</span>; <span class="o">}</span>;
  category <span class="s2">&quot;update&quot;</span> <span class="o">{</span> <span class="s2">&quot;debug&quot;</span>; <span class="o">}</span>;
  category <span class="s2">&quot;queries&quot;</span> <span class="o">{</span> <span class="s2">&quot;warning&quot;</span>; <span class="o">}</span>;
  category <span class="s2">&quot;dispatch&quot;</span> <span class="o">{</span> <span class="s2">&quot;debug&quot;</span>; <span class="o">}</span>;
  category <span class="s2">&quot;dnssec&quot;</span> <span class="o">{</span> <span class="s2">&quot;debug&quot;</span>; <span class="o">}</span>;
  category <span class="s2">&quot;lame-servers&quot;</span> <span class="o">{</span> <span class="s2">&quot;debug&quot;</span>; <span class="o">}</span>;

  channel <span class="s2">&quot;debug&quot;</span> <span class="o">{</span>
    file <span class="s2">&quot;/var/log/bind9/nameddbg&quot;</span> versions 2 size 50m;
    print-time yes;
    print-category yes;
    print-severity yes;
  <span class="o">}</span>;

  channel <span class="s2">&quot;warning&quot;</span> <span class="o">{</span>
    file <span class="s2">&quot;/var/log/bind9/nameddbg&quot;</span> versions 2 size 50m;
    severity warning;
    print-time yes;
    print-category yes;
    print-severity yes;
  <span class="o">}</span>;
<span class="o">}</span>;
</pre></div>
<p>Cette conf est très verbose, il sera peut-être nécessaire de la réduire
une fois l'installation achevée et fonctionnelle. Par défault, le
répertoire /var/log/bind9 n'existe pas et est bloqué par apparmor, il
faut donc le créer et l'autoriser:</p>
<div class="highlight"><pre>sudo mkdir /var/log/bind9
sudo chown <span class="nb">bind</span>:bind /var/log/bind9
</pre></div>
<p>Configurer apparmor pour autoriser l'écriture dans le repertoire du log:</p>
<div class="highlight"><pre>sudo vim /etc/apparmor.d/usr.sbin.named
</pre></div>
<p>et ajouter à la fin (dans la zone sur les logs):</p>
<div class="highlight"><pre>/var/log/bind9/<span class="se">\*\*</span> rw,
/var/log/bind9/ rw,
</pre></div>
<p>redémarrer apparmor
(on relancera bind à la fin de la config)</p>
<div class="highlight"><pre>sudo /etc/init.d/apparmor restart
</pre></div>
</div>
</div>
<div class="section" id="sur-le-maitre-ns1">
<h2>sur le maître (ns1)</h2>
<div class="section" id="travaux-preparatoire-generation-des-clefs-partagees">
<h3>travaux préparatoire : génération des clefs partagées</h3>
<p>des clefs seront nécessaires pour la mise à jour du dns par le dhcp,
ainsi que pour la configuration rndc (rndc est un outil de configuration
pour bind, optionnel, mais bind aime bien qu'il soit là). On va donc
aussi configurer rndc sur le maitre.</p>
<div class="section" id="rndc">
<h4>rndc</h4>
<div class="highlight"><pre><span class="nb">cd</span> /etc/bind
sudo dnssec-keygen -a hmac-md5 -b 256 -n HOST ns1
</pre></div>
<p>ce programme va générer deux fichier nommés
Kns1.xxxxxxxx.key et Kns1.xxxxxxxx.private le fichier .key va devenir
notre clef rndc:</p>
<div class="highlight"><pre>sudo mv Kns1.xxxxxxxxx.key rndc.key
</pre></div>
<p>(remplacer les xxxxxxxx par le bon nom) ensuite afficher le
contenu du fichier private:</p>
<div class="highlight"><pre>sudo cat Kns1.xxxxxxxxx.private
</pre></div>
<p>et copier le texte après 'Key:' ensuite
créer le fichier de conf rndc:</p>
<div class="highlight"><pre>sudo vim /etc/bind/rndc.conf
</pre></div>
<p>et coller les éléments suivants:</p>
<div class="highlight"><pre>key rdnc-key <span class="o">{</span>
  algorithm hmac-md5;
  secret <span class="s2">&quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span>;
<span class="o">}</span>;

options <span class="o">{</span>
  // what host should rndc attempt to control by default
  default-server 127.0.0.1;
  // and what key should it use to communicate with named
  default-key <span class="s2">&quot;rdnc-key&quot;</span>;
<span class="o">}</span>;

server 127.0.0.1 <span class="o">{</span>
  // always use this key with this host
  key <span class="s2">&quot;rdnc-key&quot;</span>;
<span class="o">}</span>;
</pre></div>
<p>et remplacer les XXXXX du secret par ce qu'on
a copié après 'Key:' du fichier Kns1.xxxxxxxxx.private on peut
maintenant effacer le fichier .private:</p>
<div class="highlight"><pre>sudo rm Kns1.xxxxxxxxx.private
</pre></div>
</div>
<div class="section" id="clef-pour-mise-a-jour-venant-du-dhcp">
<h4>clef pour mise à jour venant du dhcp</h4>
<div class="highlight"><pre><span class="nb">cd</span> /etc/bind
sudo dnssec-keygen -a hmac-md5 -b 128 -n USER dhcpupdate
</pre></div>
<p>Dans le fichier .key genéré, copier la clef : La
clef est la dernière chaine de caractère du fichier .key, par exemple
ici:</p>
<pre class="literal-block">
dhcpupdate. IN KEY 0 3 157 Zihefb3NqqepA/5RgzbicM==
</pre>
<p>la clef est: Zihefb3NqqepA/5RgzbicM==</p>
<p>avec cette clef, on a généré des directives de
configuration pour le dhcp et pour le dns, elles auront l'aspect suivant:</p>
<p>pour le dns:</p>
<div class="highlight"><pre>key dhcpupdate <span class="o">{</span>
  algorithm hmac-md5;
  secret <span class="s2">&quot;ICICOLLERLACLEFSECRETEGENEREE&quot;</span>;
<span class="o">}</span>;
</pre></div>
<p>pour le dhcp (pareil que pour le dns, mais sans les guillemets):</p>
<div class="highlight"><pre>key dhcpupdate <span class="o">{</span>
  algorithm hmac-md5;
  secret ICICOLLERLACLEFSECRETEGENEREE;
<span class="o">}</span>;
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h3>dhcp</h3>
<div class="highlight"><pre>sudo vim /etc/dhcp3/dhcpd.conf
</pre></div>
<p>et mettre le fichier de conf suivant:</p>
<div class="highlight"><pre><span class="c">#</span>
<span class="c"># Sample dhcpd.conf file</span>
<span class="c">#</span>

<span class="c"># ======== Mise a jour DDNS ========</span>
ddns-domainname <span class="s2">&quot;monentreprise.local&quot;</span>;
ddns-rev-domainname <span class="s2">&quot;1.168.192.in-addr.arpa&quot;</span>;
<span class="c">#Mehode de mise a  jour du DNS</span>
ddns-update-style interim;
<span class="c">#Mise a  jour autorisee</span>
ddns-updates on;
<span class="c">#ici on force la maj par le dhcp et non par le client</span>
ignore client-updates;
<span class="c">#on force la maj des ipfixes</span>
update-static-leases on;
<span class="c"># Clef partagee dhcpd et bind9</span>
key dhcpupdate <span class="o">{</span>
    algorithm hmac-md5;
    secret ICICOLLERLACLEFSECRETEGENEREE;
<span class="o">}</span>;

<span class="c"># ======== Option Generales du dhcp ========</span>

<span class="c"># Server name</span>
server-name <span class="s2">&quot;dhcp.monentreprise.local&quot;</span>;

<span class="c"># option definitions common to all supported networks...</span>
option domain-name <span class="s2">&quot;monentreprise.local&quot;</span>;
option domain-name-servers 192.168.1.10, 192.168.1.11;

default-lease-time 3600;
max-lease-time 7200;

<span class="c"># If this DHCP server is the official DHCP server for the local</span>
<span class="c"># network, the authoritative directive should be uncommented.</span>
authoritative;

<span class="c"># Use this to send dhcp log messages to a different log file (you also</span>
<span class="c"># have to hack syslog.conf to complete the redirection).</span>
log-facility local7;

<span class="c"># No service will be given on this subnet, but declaring it helps the</span>
<span class="c"># DHCP server to understand the network topology.</span>
subnet 192.168.1.0 netmask 255.255.255.0 <span class="o">{</span>
<span class="o">}</span>

<span class="c">#Zones</span>
zone 1.168.192.in-addr.arpa. <span class="o">{</span>
  primary 127.0.0.1;
  key dhcpupdate;
<span class="o">}</span>

zone linkcareservices.local. <span class="o">{</span>
  primary 127.0.0.1;
  key dhcpupdate;
<span class="o">}</span>

<span class="c"># ======== Failover configuration ========</span>
failover peer <span class="s2">&quot;dhcp-failover&quot;</span> <span class="o">{</span>
  primary; <span class="c"># declare this to be the primary server</span>
  address 192.168.1.10;
  port 647;
  peer address 192.168.1.11;
  peer port 647;
  max-response-delay 30;
  max-unacked-updates 10;
  load balance max seconds 3;
  mclt 1800;
  split 128;
<span class="o">}</span>

<span class="c"># ======== Reseaux ========</span>
<span class="c">## déclaration sous réseau 192.168.1.*</span>
subnet 192.168.1.0 netmask 255.255.255.0 <span class="o">{</span>
  <span class="c"># Si vous voulez spécifier un domaine différent de celui par défaut :</span>
  <span class="c">#option domain-name &quot;mon_domaine.qqc&quot;;</span>
  <span class="c">## Adresse de diffusion</span>
  option broadcast-address 192.168.1.255;
  <span class="c">## routeur par défaut</span>
  option routers 192.168.1.1;
        <span class="c">## Plage d&#39;attribution d&#39;adresse</span>
        <span class="c">## Ici on ouvre pour l&#39;instant une &#39;petite&#39; plage entre .50 et .99, c&#39;est un exemple, on peut mettre plus.</span>
  pool <span class="o">{</span>
    failover peer <span class="s2">&quot;dhcp-failover&quot;</span>;
    range 192.168.1.50 192.168.1.99;
  <span class="o">}</span>
  <span class="c"># évalue si l&#39;adresse est déjà attribuée</span>
  ping-check <span class="o">=</span> 1;
<span class="o">}</span>

host ns1 <span class="o">{</span>
  hardware ethernet 00:00:00:00:00:00;
  fixed-address 192.168.1.10;
<span class="o">}</span>

host ns2 <span class="o">{</span>
  hardware ethernet 00:00:00:00:00:00;
  fixed-address 192.168.1.11;
<span class="o">}</span>
</pre></div>
<p>Pour que le fichier de configuration soit complet, il faudra
remplacer les ICICOLLERLACLEFSECRETEGENEREE de la clef par la clef
générée précedemment. Il y a également deux baux statiques dans le
fichier de configuration pour nos serveurs ns1 et ns2, il faut remplacer
les 00:00... des adresses MAC par les vraies adresses mac de vos
machines.</p>
</div>
<div class="section" id="id2">
<h3>dns</h3>
<div class="section" id="named-conf">
<h4>named.conf</h4>
<p>ce fichier représente la configuration principale du dns, on va juste
ajouter quelques directives en début de fichier:</p>
<div class="highlight"><pre>sudo vim /etc/bind/named.conf
</pre></div>
<p>et ajouter en début de fichier les
éléments suivants:</p>
<div class="highlight"><pre>acl internals <span class="o">{</span> 127.0.0.0/8; 192.168.1.0/24; <span class="o">}</span>;

controls <span class="o">{</span>
  inet 127.0.0.1 allow <span class="o">{</span> 127.0.0.1; localhost; <span class="o">}</span> keys <span class="o">{</span> <span class="s2">&quot;rdnc-key&quot;</span>; <span class="o">}</span>;
<span class="o">}</span>;

key rdnc-key <span class="o">{</span>
  algorithm hmac-md5;
  secret <span class="s2">&quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span>;
<span class="o">}</span>;

key dhcpupdate <span class="o">{</span>
  algorithm hmac-md5;
  secret <span class="s2">&quot;ICICOLLERLACLEFSECRETEGENEREE&quot;</span>;
<span class="o">}</span>;
</pre></div>
<p>en remplaçant XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
par la clef rndc générée précedemment, et en remplaçant
ICICOLLERLACLEFSECRETEGENEREE par la clef dhcpupdate générée plus haut.</p>
</div>
<div class="section" id="named-conf-options">
<h4>named.conf.options</h4>
<div class="highlight"><pre>sudo vim /etc/bind/named.conf.options
</pre></div>
<p>Comme on est en train de construire des serveurs pour un petit réseau interne,
nous n'avons pas besoin que les dns résolvent tout internet, on va donc
les configurer pour faire relais vers d'autre dns. L'avantage, c'est
qu'on peut choisir ceux qu'on veut, et pas obligatoirement ceux de son
ISP, même si au final il est quand même préférable d'en choisir des pas
trop loin et si possible performants. Les DNS des ISP répondent souvent
à ces problématiques. Vous pouvez aussi mettre simplement le dns de
votre routeur/box en relais, nos dns internes servant au final à gérer
les zones internes. Le fichier complet ressemble donc à ceci:</p>
<div class="highlight"><pre>options <span class="o">{</span>
        directory <span class="s2">&quot;/var/lib/bind&quot;</span>;

        // If there is a firewall between you and nameservers you want
        // to talk to, you may need to fix the firewall to allow multiple
        // ports to talk.  See http://www.kb.cert.org/vuls/id/800113

        // If your ISP provided one or more IP addresses <span class="k">for </span>stable
        // nameservers, you probably want to use them as forwarders.
        // Uncomment the following block, and insert the addresses replacing
        // the all-0<span class="err">&#39;</span>s placeholder.

        // forwarders <span class="o">{</span>
        //      0.0.0.0;
        // <span class="o">}</span>;
  forwarders <span class="o">{</span>
    aa.bb.cc.dd;
    ee.ff.gg.hh;
    192.168.1.1;
  <span class="o">}</span>;

        auth-nxdomain no;    <span class="c"># conform to RFC1035</span>
        listen-on-v6 <span class="o">{</span> none; <span class="o">}</span>;
  listen-on <span class="o">{</span> 127.0.0.1; 192.168.1.10; 192.168.1.11; <span class="o">}</span>;

  // transférer les informations de zones aux DNS secondaires
  allow-transfer <span class="o">{</span> 192.168.1.11; <span class="o">}</span>;

  // Accepter les requêtes pour le réseau interne uniquement
  allow-query <span class="o">{</span> internals; <span class="o">}</span>;

  // Autoriser les requêtes récursives pour les hôtes locaux
  allow-recursion <span class="o">{</span> internals; <span class="o">}</span>;

  // Ne pas rendre publique la version de BIND
  version none;

<span class="o">}</span>;
</pre></div>
<p>dans la zone 'forwarders', vous pouvez donc remplacer les ips aa.bb.cc.dd et
ee.ff.gg.hh par deux dns publics ou ceux de votre isp, ou vous pouvez
enlever les lignes pour ne garder que le dns du routeur. Dans cette
config, on autorise le transfert des infos de DNS vers notre futur
secondaire. Il y a un autre élément important dans ce fichier de config:
le répertoire par défaut de travail de bind qui doit être
/var/lib/bind: sous ubuntu 9.04, par défaut, seul ce répertoire
autorise bind à écrire dans le fichier et c'est nécessaire pour la maj
ddns venant du dhcp.</p>
</div>
<div class="section" id="named-conf-local">
<h4>named.conf.local</h4>
<div class="highlight"><pre>sudo vim /etc/bind/named.conf.local
</pre></div>
<p>insérer les zones et les reverses:</p>
<div class="highlight"><pre>///
// Do any <span class="nb">local </span>configuration here
//

// Consider adding the 1918 zones here, <span class="k">if </span>they are not used in your
// organization
//include <span class="s2">&quot;/etc/bind/zones.rfc1918&quot;</span>;

include <span class="s2">&quot;/etc/bind/named.conf.debug.log&quot;</span>;

zone <span class="s2">&quot;monentreprise.local&quot;</span> <span class="o">{</span>
    <span class="nb">type </span>master;
    notify yes;
    allow-transfer <span class="o">{</span> 192.168.1.11; <span class="o">}</span> ;
    file <span class="s2">&quot;monentreprise.local.hosts&quot;</span>;
<span class="o">}</span>;

zone <span class="s2">&quot;1.168.192.in-addr.arpa&quot;</span> <span class="o">{</span>
    <span class="nb">type </span>master;
    notify yes;
    allow-transfer <span class="o">{</span> 192.168.1.11; <span class="o">}</span> ;
    file <span class="s2">&quot;1.168.192.in-addr.arpa.zone&quot;</span>;
<span class="o">}</span>;
</pre></div>
<p>Cette config indique que ce dns est 'master' pour les deux zones et qu'il
notifie et transfère les infos de zones vers le secondaire. De plus, il
pointe sur une configuration de debug particulière qui est utile pour
l'analyse des problème de la configuration et que l'on a paramétré
précédemment.</p>
</div>
<div class="section" id="les-fichiers-de-zones">
<h4>les fichiers de zones</h4>
<p>Il faut maintenant créer les fichier de la zone et du reverse. On va les
créer dans /etc/bind, puis les lier dans /var/lib/bind/ où va vraiment
aller les chercher bind, suite à notre config dans options.</p>
<div class="highlight"><pre>sudo vim /etc/bind/monentreprise.local.hosts
</pre></div>
<p>et mettre les infos suivantes (c'est un exemple, mais qui est paramétré
avec deux serveurs DNS pour préparer la conf/maitre-esclave)</p>
<div class="highlight"><pre>@      IN     SOA     ns1.monentreprise.local. email.monentreprise.com. <span class="o">(</span>
            20092909003 ; serial
            600 ; refresh after 10 minutes <span class="o">(</span><span class="k">for </span>testing purpose<span class="o">)</span>
            3600 ; retry after 1 hour
            604800 ; expires after 1 week
            86400 <span class="o">)</span> ; minimum TTL of 1 day
@     IN     NS     ns1.monentreprise.local.
@     IN     NS     ns2.monentreprise.local.
gw          IN  A       192.168.1.1
ns1         IN  A       192.168.1.10
ns2         IN  A       192.168.1.11
dhcp        IN  CNAME   ns1
dhcp2         IN  CNAME   ns2
</pre></div>
<p>Dans la premiere ligne, il faut indiquer un email après le serveur (ne pas
oublier les '.' à la fin). bizarrement, l'email est de la forme
email.domaine.suffixe. alors que cela veut dire <a class="reference external" href="mailto:email&#64;domaine.suffixe">email&#64;domaine.suffixe</a>
faire de même avec le reverse:</p>
<div class="highlight"><pre>sudo vim /etc/bind/1.168.192.in-addr.arpa.zone
</pre></div>
<div class="highlight"><pre>@       IN    SOA     ns1.monentreprise.local. email.monentreprise.com. <span class="o">(</span>
            20090929002 ; serial
            600 ; refresh after 10 minutes <span class="o">(</span><span class="k">for </span>testing purpose<span class="o">)</span>
            3600 ; retry after 1 hour
            604800 ; expires after 1 week
            86400 <span class="o">)</span> ; minimum TTL of 1 day
@       IN     NS     ns1.monentreprise.local.
@       IN     NS     ns2.monentreprise.local.
1       IN     PTR    gw.monentreprise.local.
10     IN     PTR    ns1.monentreprise.local.
11     IN     PTR    ns2.monentreprise.local.
</pre></div>
<p>Pour ces deux fichiers, si vous les
modifiez à la main, il est important de faire évoluer le sérial à chaque
modification. Sinon le DNS principal n'ira pas notifier le secondaire.
maintenant on va faire en sorte que ces fichiers soient dispos dans
/var/lib/bind et modifiables par bind:</p>
<div class="highlight"><pre>sudo chown <span class="nb">bind</span>:bind /etc/bind/monentreprise.local.hosts
sudo chown <span class="nb">bind</span>:bind /etc/bind/1.168.192.in-addr.arpa.zone
sudo ln -s /etc/bind/monentreprise.local.hosts /var/lib/bind/monentreprise.local.hosts
sudo ln -s /etc/bind/1.168.192.in-addr.arpa.zone /var/lib/bind/1.168.192.in-addr.arpa.zone
</pre></div>
</div>
</div>
<div class="section" id="redemarrage">
<h3>redémarrage</h3>
<p>on peut enfin redémarrer bind et démarrer le dhcp</p>
<div class="highlight"><pre>sudo /etc/init.d/bind9 restart
sudo /etc/init.d/dhcp3-server start
</pre></div>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p class="last"><strong>Attention :</strong> il ne faut pas oublier de désactiver le ou les
précédents serveurs dhcp sur le réseau (celui du routeur/de la box par
exemple).</p>
</div>
</div>
</div>
<div class="section" id="sur-l-esclave-ns2">
<h2>sur l'esclave (ns2)</h2>
<p>La conf sur l'esclave est plus simple car il n'y a pas de système de maj
ddns et les fichiers de zones dns sur récupérées automatiquement du
maitre.</p>
<div class="section" id="id3">
<h3>dhcp</h3>
<div class="highlight"><pre>sudo vim /etc/dhcp3/dhcpd.conf
</pre></div>
<p>et mettre la conf suivante:</p>
<div class="highlight"><pre><span class="c">#</span>
<span class="c"># Sample dhcpd.conf file</span>
<span class="c">#</span>

<span class="c"># ======== Mise a jour DDNS ========</span>
ddns-update-style none;

<span class="c"># ======== Option Generales du dhcp ========</span>
<span class="c"># Server name</span>
server-name <span class="s2">&quot;dhcp2.monentreprise.local&quot;</span>;

<span class="c"># option definitions common to all supported networks...</span>
option domain-name <span class="s2">&quot;monentreprise.local&quot;</span>;
option domain-name-servers 192.168.1.10, 192.168.1.11;

default-lease-time 3600;
max-lease-time 7200;

<span class="c"># If this DHCP server is the official DHCP server for the local</span>
<span class="c"># network, the authoritative directive should be uncommented.</span>
authoritative;

<span class="c"># Use this to send dhcp log messages to a different log file (you also</span>
<span class="c"># have to hack syslog.conf to complete the redirection).</span>
log-facility local7;

<span class="c"># No service will be given on this subnet, but declaring it helps the</span>
<span class="c"># DHCP server to understand the network topology.</span>
subnet 192.168.1.0 netmask 255.255.255.0 <span class="o">{</span>
<span class="o">}</span>

<span class="c"># ======== Failover configuration ========</span>
failover peer <span class="s2">&quot;dhcp-failover&quot;</span> <span class="o">{</span>
  secondary; <span class="c"># declare this to be the secondary server</span>
  address 192.168.1.11;
  port 647;
  peer address 192.168.1.10;
  peer port 647;
  max-response-delay 30;
  max-unacked-updates 10;
  load balance max seconds 3;
<span class="o">}</span>

<span class="c"># ======== Reseaux ========</span>
<span class="c">## déclaration sous réseau 192.168.1.*</span>
subnet 192.168.1.0 netmask 255.255.255.0 <span class="o">{</span>
  <span class="c"># Si vous voulez spécifier un domaine différent de celui par défaut :</span>
  <span class="c">#option domain-name &quot;mon_domaine.qqc&quot;;</span>
  <span class="c">## Adresse de diffusion</span>
  option broadcast-address 192.168.1.255;
  <span class="c">## routeur par défaut</span>
  option routers 192.168.1.1;
        <span class="c">## Plage d&#39;attribution d&#39;adresse</span>
        <span class="c"># Ici on ouvre pour l&#39;instant une &#39;petite&#39; plage entre .50 et .99, c&#39;est un exemple, on peut mettre plus.</span>
  pool <span class="o">{</span>
    failover peer <span class="s2">&quot;dhcp-failover&quot;</span>;
    range 192.168.1.50 192.168.1.99;
  <span class="o">}</span>
  <span class="c"># évalue si l&#39;adresse est déjà attribuée</span>
  ping-check <span class="o">=</span> 1;
<span class="o">}</span>

host ns1 <span class="o">{</span>
  hardware ethernet 00:00:00:00:00:00;
  fixed-address 192.168.1.10;
<span class="o">}</span>

host ns2 <span class="o">{</span>
  hardware ethernet 00:00:00:00:00:00;
  fixed-address 192.168.1.11;
<span class="o">}</span>
</pre></div>
<p>Comme pour le dhcp maître, il y a deux baux statiques dans le
fichier de configuration pour nos serveurs ns1 et ns2, il faut remplacer
les 00:00… des adresses MAC par les vraies adresses mac de vos machines.</p>
</div>
<div class="section" id="id4">
<h3>dns</h3>
<div class="section" id="id5">
<h4>named.conf</h4>
<div class="highlight"><pre>sudo vim /etc/bind/named.conf
</pre></div>
<p>ajouter juste, en début de fichier, l'acl internals:</p>
<div class="highlight"><pre>acl internals <span class="o">{</span> 127.0.0.0/8; 192.168.1.0/24; <span class="o">}</span>;
</pre></div>
</div>
<div class="section" id="id6">
<h4>named.conf.options</h4>
<div class="highlight"><pre>sudo vim /etc/bind/named.conf.options
</pre></div>
<p>Ce fichier est très proche de celui du maitre, sauf qu'il n'a plus la
directive 'allow-transfer':</p>
<div class="highlight"><pre>options <span class="o">{</span>
        directory <span class="s2">&quot;/var/lib/bind&quot;</span>;

        // If there is a firewall between you and nameservers you want
        // to talk to, you may need to fix the firewall to allow multiple
        // ports to talk.  See http://www.kb.cert.org/vuls/id/800113

        // If your ISP provided one or more IP addresses <span class="k">for </span>stable
        // nameservers, you probably want to use them as forwarders.
        // Uncomment the following block, and insert the addresses replacing
        // the all-0<span class="err">&#39;</span>s placeholder.

        // forwarders <span class="o">{</span>
        //      0.0.0.0;
        // <span class="o">}</span>;
  forwarders <span class="o">{</span>
    aa.bb.cc.dd;
    ee.ff.gg.hh;
    192.168.1.1;
  <span class="o">}</span>;

        auth-nxdomain no;    <span class="c"># conform to RFC1035</span>
        listen-on-v6 <span class="o">{</span> none; <span class="o">}</span>;
  listen-on <span class="o">{</span> 127.0.0.1; 192.168.1.10; 192.168.1.11; <span class="o">}</span>;

  // transférer les informations de zones aux DNS secondaires
  allow-transfer <span class="o">{</span> 192.168.1.11; <span class="o">}</span>;

  // Accepter les requêtes pour le réseau interne uniquement
  allow-query <span class="o">{</span> internals; <span class="o">}</span>;

  // Autoriser les requêtes récursives pour les hôtes locaux
  allow-recursion <span class="o">{</span> internals; <span class="o">}</span>;

  // Ne pas rendre publique la version de BIND
  version none;

<span class="o">}</span>;
</pre></div>
</div>
<div class="section" id="id7">
<h4>named.conf.local</h4>
<div class="highlight"><pre>sudo vim /etc/bind/named.conf.local
</pre></div>
<p>Ici la conf est sensiblement différente, car on précise que les zones sont
'esclaves':</p>
<div class="highlight"><pre>//
// Do any <span class="nb">local </span>configuration here
//

// Consider adding the 1918 zones here, <span class="k">if </span>they are not used in your
// organization
//include <span class="s2">&quot;/etc/bind/zones.rfc1918&quot;</span>;

include <span class="s2">&quot;/etc/bind/named.conf.debug.log&quot;</span>;

zone <span class="s2">&quot;linkcareservices.local&quot;</span> <span class="o">{</span>
    <span class="nb">type </span>slave;
    masters <span class="o">{</span>192.168.1.10;<span class="o">}</span> ;
    file <span class="s2">&quot;linkcareservices.local.hosts&quot;</span>;
<span class="o">}</span>;

zone <span class="s2">&quot;1.168.192.in-addr.arpa&quot;</span> <span class="o">{</span>
    <span class="nb">type </span>slave;
    masters <span class="o">{</span>192.168.1.10;<span class="o">}</span> ;
    file <span class="s2">&quot;1.168.192.in-addr.arpa.zone&quot;</span>;
<span class="o">}</span>;
</pre></div>
<p>Il n'y a pas besoin de
créer à la main les fichiers de zones : ils seront transférés
automatiquement depuis le maitre.</p>
</div>
</div>
<div class="section" id="id8">
<h3>redémarrage</h3>
<p>on peut enfin redémarrer bind et démarrer le dhcp</p>
<div class="highlight"><pre>sudo /etc/init.d/bind9 restart
sudo /etc/init.d/dhcp3-server start
</pre></div>
</div>
</div>
<div class="section" id="debugging">
<h2>Debugging</h2>
<p>Ce tuto est censé marcher directement, mais vous rencontrez des
problèmes, voici quelques infos / trucs pour débugger les problèmes.
J'essaierais de faire évoluer cette zone au fur et à mesure.</p>
<div class="section" id="analyser-les-logs">
<h3>analyser les logs</h3>
<p>les logs du dhcp sont dans /var/log/syslog les logs du dns sont dans
/var/log/bind9/nameddbg Avant tout, il faut bien regarder ces logs à la
recherce de problèmes</p>
</div>
<div class="section" id="j-ai-beau-changer-mes-conf-dns-mon-probleme-persiste">
<h3>j'ai beau changer mes conf dns, mon problème persiste</h3>
<p>Je me suis cassé la tête des heures durant sur des problèmes de MAJ ddns
du dhcp vers le dns qui ne marchaient pas. Au final, le pb était qu'il y
avait deux dns qui tournaient sur la machine. Ce pb a l'air plus courant
qu'il n'y parait : ça m'est déjà arrivé deux fois (et deux fois je suis
tombé dans le panneau). C'est peut-être un pb dans le restart du serveur
dans init.d qui ne marche pas bien. Donc si vous avez un doute:</p>
<div class="highlight"><pre>sudo /etc/init.d/bind9 stop
</pre></div>
<p>puis:</p>
<div class="highlight"><pre>ps -ef | grep named
</pre></div>
<p>et si le ps montre un process named qui tourne encore, alors ne pas hésiter à le killer sauvagement:</p>
<div class="highlight"><pre>sudo <span class="nb">kill</span> -9 XXXXXX
</pre></div>
<p>XXXXXX étant le numéro du process. puis:</p>
<div class="highlight"><pre>sudo /etc/init.d/bind9 start
</pre></div>
</div>
</div>
<p>There are <a href=".././installation-dun-couple-de-serveurs-dhcp-et-dns-redondants.html#disqus_thread">comments</a>.</p>
                </article>
                
            </aside><!-- /#featured -->
            
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">
            
        
        
        
            

        
         
            
            <li><article class="hentry">    
                <header>
                    <h1><a href=".././installation-dun-serveur-web-securise-sous-ubuntu-9-04server.html" rel="bookmark"
                           title="Permalink to Installation d'un serveur web sécurisé sous Ubuntu server (9.04 à 10.04)">Installation d'un serveur web sécurisé sous Ubuntu server (9.04 à 10.04)</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2009-08-18T00:58:00">
                Tue 18 August 2009
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href=".././author/thomas-chiroux.html">Thomas Chiroux</a>
        </address>
        
<p>In <a href=".././category/adminsys.html">adminsys</a>. </p>
<p>tags: <a href=".././tag/904.html">9.04</a> <a href=".././tag/configuration.html">configuration</a> <a href=".././tag/installation.html">installation</a> <a href=".././tag/jaunty.html">jaunty</a> <a href=".././tag/lighttpd.html">lighttpd</a> <a href=".././tag/linux.html">linux</a> <a href=".././tag/mysql.html">mysql</a> <a href=".././tag/php.html">php</a> <a href=".././tag/ubuntu.html">ubuntu</a> </p>


</footer><!-- /.post-info -->
                <img alt="ubuntu logo" src="../static/media/images/ubuntu-logo.png" style="width: 105px; height: 100px;" />
<p>Cet article est le premier d'une série sur l'admin
système linux. On va donc commencer par les bases : installer un ubuntu
server avec une sécurité correcte et on en profite pour installer un
LLMP dessus (c'est LAMP mais avec Lighttpd à la place de apache :-))
Pour ce ...</p>
                <a class="readmore" href=".././installation-dun-serveur-web-securise-sous-ubuntu-9-04server.html">read more</a>
                <p>There are <a href=".././installation-dun-serveur-web-securise-sous-ubuntu-9-04server.html#disqus_thread">comments</a>.</p>
                </div><!-- /.entry-content -->
            </article></li>
        
        
            </ol><!-- /#posts-list -->
            
                
<p class="paginator">
    
    Page 1 / 1
    
</p>

            
            </section><!-- /#content -->
        
    


        <section id="extras" class="body">
        
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                        
                            <li><a href="http://www.afpy.org/">afpy</a></li>
                        
                            <li><a href="http://www.april.org/">april</a></li>
                        
                            <li><a href="http://www.laquadrature.net/fr">la quadrature du net</a></li>
                        
                        </ul>
                </div><!-- /.blogroll -->
        
        
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://chiroux.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            

                        
                            <li><a href="https://twitter.com/ThomasChiroux">twitter</a></li>
                        
                            <li><a href="https://plus.google.com/113683015116617526200/">google+</a></li>
                        
                            <li><a href="https://github.com/ThomasChiroux">github</a></li>
                        
                        </ul>
                </div><!-- /.social -->
        
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
		<p>Sauf si précisé différemment, tout le contenu de ce site est sous licence <a href="http://creativecommons.org/licenses/by-sa/2.0/fr/">creative common CC BY-SA 2.0</a></p>
                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->


    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-36757276-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>



<script type="text/javascript">
    var disqus_shortname = 'chirouxorg';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</body>
</html>